name: Update Website Data

on:
  schedule:
    - cron: '0 * * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ
  workflow_dispatch:       # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install requests
        run: pip install requests

      - name: Create data directory
        run: mkdir -p scripts

      - name: Fetch GitHub repositories
        run: python scripts/fetch_github.py

      - name: Fetch PyPI packages  
        run: python scripts/fetch_pypi.py

      - name: Fetch Dev.to articles
        run: python scripts/fetch_devto.py

      - name: Fetch Zenodo stats
        run: python scripts/fetch_zenodo.py

      - name: Show file sizes
        run: |
          echo "ğŸ“ Generated files:"
          ls -la *.json
          echo ""
          echo "ğŸ“Š File sizes:"
          wc -c *.json

      - name: Show usage statistics
        run: |
          echo "=== ğŸ“ˆ USAGE STATISTICS ==="
          echo "ğŸƒ Workflow runs per day: 24"
          echo "â±ï¸ Estimated time: 48 minutes/day"
          echo ""
          echo "ğŸŒ API calls per day:"
          echo "  - GitHub: 24 calls"
          echo "  - PyPI: 552 calls (24 Ã— 23 packages)"
          echo "  - Dev.to: 24 calls" 
          echo "  - Zenodo: 72 calls (24 Ã— 3 records)"
          echo "  ğŸ“Š TOTAL: 672 API calls/day"
          echo ""
          echo "ğŸ’¾ Storage usage:"
          echo "  - 4 JSON files updated hourly"
          echo "  - Minimal disk space"
          echo ""
          echo "âœ… STATUS: WELL WITHIN GITHUB LIMITS"
          echo "====================================="

      - name: Commit and push updates
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          git add *.json
          if git diff --staged --quiet; then
            echo "ğŸ‰ No data changes - everything up to date!"
          else
            git commit -m "ğŸš€ Data update: $(date -Iminutes)"
            git push origin main
            echo "ğŸ”¥ Data successfully updated and pushed!"
          fi

      - name: Final success message
        run: |
          echo ""
          echo "#############################################"
          echo "ğŸ‰ WEBSITE DATA UPDATE COMPLETE!"
          echo "ğŸ“… Next update: 1 hour"
          echo "ğŸŒ JSON files ready for websites:"
          echo "   - github_repos.json"
          echo "   - pypi_packages.json" 
          echo "   - devto_articles.json"
          echo "   - zenodo_stats.json"
          echo "#############################################"
